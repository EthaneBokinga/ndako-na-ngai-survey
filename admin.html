<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin — Ndako na Ngai</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css" />
    <link rel="stylesheet" href="styles.css" />
    <style>
      body { background: #f5f7fa; }
      .admin-wrap{ max-width:1200px; margin:24px auto; padding:24px; background:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
      .admin-tabs { display: flex; gap: 12px; border-bottom: 2px solid #e6e9ef; margin-bottom: 24px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
      .admin-tabs button { background: none; border: none; padding: 12px 16px; font-size: 14px; font-weight: 600; cursor: pointer; color: #6b7280; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap; flex-shrink: 0; }
      .admin-tabs button.active { color: #2563eb; border-bottom-color: #2563eb; }
      .tab-content { display: none; }
      .tab-content.active { display: block; }
      
      .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 24px; }
      .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px; border-radius: 12px; text-align: center; }
      .stat-card.alt1 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
      .stat-card.alt2 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
      .stat-card.alt3 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
      .stat-card h4 { margin: 0; font-size: 11px; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }
      .stat-card .value { font-size: 24px; font-weight: 700; margin: 8px 0 0; }

      table { width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 13px; }
      thead { background: #f8fafc; }
      th { padding: 10px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e6e9ef; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
      td { padding: 10px; border-bottom: 1px solid #e6e9ef; color: #6b7280; font-size: 12px; }
      tbody tr:hover { background: #f9fafb; }

      /* Responsive cards for mobile: hide table on small screens and show cards */
      .response-cards { display: none; }
      .response-card { background: #ffffff; border: 1px solid #eef2f7; padding: 12px; border-radius: 10px; margin-bottom: 12px; box-shadow: 0 2px 6px rgba(15,23,42,0.03); }
      .response-card .card-row { display: flex; gap: 12px; align-items: center; justify-content: space-between; }
      .response-card .card-meta { font-weight:700; color:#111827; }
      .response-card .card-body { color:#374151; font-size:13px; }
      .response-card .card-body p { margin:4px 0; }
      .response-card .card-actions button { padding:8px 12px; border-radius:8px; }
      .response-card .btn { background: linear-gradient(90deg,#2563eb,#4f46e5); color: white; border: none; padding: 8px 12px; border-radius: 8px; box-shadow: 0 6px 14px rgba(37,99,235,0.18); cursor: pointer; }
      .response-card .btn:hover { transform: translateY(-1px); }
      .response-card .card-meta { font-size: 15px; color: #0f172a; font-weight: 700; }
      .response-card .card-body strong { color: #111827; }
      .feature-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; margin-top: 16px; }
      .feature-item { background: #f8fafc; padding: 12px; border-radius: 8px; border-left: 4px solid #2563eb; }
      .feature-item strong { color: #1f2937; font-size: 12px; }
      .feature-item .count { background: #2563eb; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; display: inline-block; margin-left: 4px; }
      
      .location-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-top: 16px; }
      .location-card { background: #f8fafc; padding: 12px; border-radius: 8px; border: 1px solid #e6e9ef; }
      .location-card h4 { margin: 0 0 8px; color: #1f2937; font-size: 13px; }
      .location-card p { margin: 4px 0; color: #6b7280; font-size: 11px; }
      
      .filters { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
      .filters select { padding: 8px 12px; border: 1px solid #e6e9ef; border-radius: 6px; font-size: 13px; background: white; cursor: pointer; }
      .filters select:hover { border-color: #2563eb; }

      .login { max-width: 420px; margin: 60px auto; padding: 24px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
      .login h3 { margin: 0 0 8px; color: #1f2937; }
      .login p { color: #6b7280; margin: 0 0 16px; font-size: 13px; }
      .login label { display: block; margin-top: 12px; font-weight: 600; color: #374151; font-size: 13px; }
      .login input { width: 100%; padding: 10px; border: 1px solid #e6e9ef; border-radius: 6px; font-size: 13px; margin-top: 4px; box-sizing: border-box; }
      .login input:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
      .login button { width: 100%; margin-top: 16px; }
      .login #loginMsg { margin-top: 12px; color: #dc2626; font-size: 12px; }

      /* Mobile responsive */
      @media (max-width: 768px) {
        .admin-wrap{ padding: 16px; margin: 12px; }
        .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .stat-card { padding: 12px; }
        .stat-card h4 { font-size: 10px; }
        .stat-card .value { font-size: 20px; }
        .admin-tabs { gap: 8px; margin-bottom: 16px; }
        .admin-tabs button { padding: 10px 12px; font-size: 12px; }
        .feature-list { grid-template-columns: 1fr; }
        .location-grid { grid-template-columns: 1fr; }
        table { font-size: 12px; }
        th, td { padding: 8px; font-size: 11px; }
      }

      @media (max-width: 480px) {
        .admin-wrap{ padding: 12px; margin: 8px; }
        .stats-grid { grid-template-columns: 1fr; gap: 8px; }
        .stat-card { padding: 10px; }
        .stat-card h4 { font-size: 9px; }
        .stat-card .value { font-size: 18px; }
        .admin-tabs { gap: 4px; margin-bottom: 12px; }
        .admin-tabs button { padding: 8px 10px; font-size: 11px; }
        .feature-list { grid-template-columns: 1fr; }
        .location-grid { grid-template-columns: 1fr; }
        .feature-item { padding: 10px; }
        .feature-item strong { font-size: 11px; }
        .location-card { padding: 10px; }
        .location-card h4 { font-size: 12px; margin-bottom: 6px; }
        .location-card p { font-size: 10px; margin: 2px 0; }
        table { font-size: 11px; }
        th, td { padding: 6px; font-size: 10px; }
        /* On small screens, hide wide table and show card list */
        table { display: none; }
        .response-cards { display: block; }
        .response-card .card-row { flex-direction: column; align-items: flex-start; }
        .response-card .card-actions { width: 100%; margin-top: 8px; }
        .response-card .card-actions button { width: 100%; }
        .login { padding: 16px; }
      }
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="container header-inner">
        <div class="brand"><div class="logo"><i class="fas fa-house"></i></div><div class="title">Admin — Ndako na Ngai</div></div>
        <div class="header-actions">
          <a href="index.html" class="btn ghost">← Retour</a>
        </div>
      </div>
    </header>

    <main>
      <div class="container">
        <div id="adminArea"></div>
      </div>
    </main>

    <!-- Firebase SDKs for admin (compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
    <script src="firebase-config.js"></script>
    <script>
      const adminArea = document.getElementById('adminArea');
      let allEntries = [];

      function renderLogin(){
        adminArea.innerHTML = `
          <div class="login">
            <h3><i class="fas fa-lock" style="color:#2563eb;margin-right:8px"></i>Connexion administrateur</h3>
            <p>Utilisez un compte administrateur créé dans la console Firebase.</p>
            <label><i class="fas fa-envelope"></i> Email</label>
            <input id="adminEmail" type="email" placeholder="admin@example.com" />
            <label><i class="fas fa-key"></i> Mot de passe</label>
            <input id="adminPass" type="password" placeholder="••••••••" />
            <button id="btnLogin" class="btn" style="width:100%;margin-top:16px">Se connecter</button>
            <div id="loginMsg"></div>
          </div>`;

        document.getElementById('btnLogin').addEventListener('click', function(){
          const email = document.getElementById('adminEmail').value.trim();
          const pass = document.getElementById('adminPass').value.trim();
          if(!email || !pass) { document.getElementById('loginMsg').textContent = 'Email et mot de passe requis'; return; }
          window.firebaseAuth.signInWithEmailAndPassword(email, pass).then(()=>{
            renderAdmin();
          }).catch(err=>{ document.getElementById('loginMsg').textContent = 'Erreur: '+err.message; });
        });
      }

      function renderAdmin(){
        adminArea.innerHTML = '<div class="admin-wrap"><h2>Chargement...</h2></div>';
        if(window.firebaseDB){
          window.firebaseDB.collection('surveys').orderBy('_ts','desc').get().then(qs=>{
            allEntries = qs.docs.map(d=>({id:d.id,data:d.data()}));
            showAdminDashboard();
          }).catch(err=>{ adminArea.innerHTML = '<div class="login"><h3>Erreur</h3><p>'+err.message+'</p></div>'; });
        } else {
          const raw = localStorage.getItem('ndaSurvey');
          allEntries = raw ? JSON.parse(raw).map((e,i)=>({id:i,data:Object.assign({_ts:e.ts}, e.data)})) : [];
          showAdminDashboard();
        }
      }

      function showAdminDashboard(){
        let html = '<div class="admin-wrap">';
        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px"><h2 style="margin:0"><i class="fas fa-chart-bar" style="color:#2563eb;margin-right:8px"></i>Tableau de bord</h2><button id="btnLogout" class="btn ghost">Déconnexion</button></div>';
        
        // Stats
        html += '<div class="stats-grid">';
        html += `<div class="stat-card"><h4>Réponses</h4><div class="value">${allEntries.length}</div></div>`;
        const cities = [...new Set(allEntries.map(e=>e.data.city).filter(c=>c))];
        html += `<div class="stat-card alt1"><h4>Villes</h4><div class="value">${cities.length}</div></div>`;
        const difficulties = allEntries.filter(e=>e.data.difficulty === 'oui').length;
        html += `<div class="stat-card alt2"><h4>Difficultés</h4><div class="value">${difficulties}</div></div>`;
        const avgAge = allEntries.length > 0 ? (allEntries.filter(e=>e.data.age).length / allEntries.length * 100).toFixed(0) : 0;
        html += `<div class="stat-card alt3"><h4>Profil complet</h4><div class="value">${avgAge}%</div></div>`;
        html += '</div>';

        // Tabs
        html += '<div class="admin-tabs">';
        html += '<button class="tab-btn active" data-tab="responses"><i class="fas fa-list"></i> Réponses</button>';
        html += '<button class="tab-btn" data-tab="features"><i class="fas fa-star"></i> Fonctionnalités</button>';
        html += '<button class="tab-btn" data-tab="locations"><i class="fas fa-map-marker-alt"></i> Villes & Quartiers</button>';
        html += '<button class="tab-btn" data-tab="insights"><i class="fas fa-lightbulb"></i> Insights</button>';
        html += '</div>';

        // Responses Tab
        html += '<div id="responses" class="tab-content active">';
        html += renderResponsesTab();
        html += '</div>';

        // Features Tab
        html += '<div id="features" class="tab-content">';
        html += renderFeaturesTab();
        html += '</div>';

        // Locations Tab
        html += '<div id="locations" class="tab-content">';
        html += renderLocationsTab();
        html += '</div>';

        // Insights Tab
        html += '<div id="insights" class="tab-content">';
        html += renderInsightsTab();
        html += '</div>';

        html += '</div>';
        adminArea.innerHTML = html;

        // Tab events
        document.querySelectorAll('.tab-btn').forEach(btn=>{
          btn.addEventListener('click', function(){
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
            this.classList.add('active');
            document.getElementById(this.dataset.tab).classList.add('active');
          });
        });

        // Logout
        document.getElementById('btnLogout').addEventListener('click', ()=>{
          window.firebaseAuth.signOut().then(()=>renderLogin());
        });
      }

      function renderResponsesTab(){
        let html = '<h3>Détails des réponses</h3>';
        // Desktop table (hidden on small screens)
        html += '<div class="table-wrapper" style="overflow-x:auto">';
        html += '<table>';
        html += '<thead><tr><th>#</th><th>Date</th><th>Ville</th><th>Âge</th><th>Profession</th><th>Difficulté</th><th>Actions</th></tr></thead><tbody>';
        allEntries.forEach((e,i)=>{
          const ts = e.data._ts || 0;
          const date = ts ? new Date(ts).toLocaleDateString('fr-FR') : '—';
          const city = e.data.city || '—';
          const age = e.data.age || '—';
          const prof = e.data.profession || '—';
          const diff = e.data.difficulty === 'oui' ? '<span style="color:#dc2626">Oui</span>' : (e.data.difficulty === 'parfois' ? '<span style="color:#f59e0b">Parfois</span>' : '<span style="color:#059669">Non</span>');
          html += `<tr><td>${i+1}</td><td>${date}</td><td>${city}</td><td>${age}</td><td>${prof}</td><td>${diff}</td><td><button class="btn ghost" onclick="showDetail(${i})" style="padding:6px 10px;font-size:12px">Voir</button></td></tr>`;
        });
        html += '</tbody></table></div>';

        // Mobile card list (visible on small screens)
        html += '<div class="response-cards">';
        allEntries.forEach((e,i)=>{
          const ts = e.data._ts || 0;
          const date = ts ? new Date(ts).toLocaleDateString('fr-FR') : '—';
          const city = e.data.city || '—';
          const age = e.data.age || '—';
          const prof = e.data.profession || '—';
          const diff = e.data.difficulty === 'oui' ? 'Oui' : (e.data.difficulty === 'parfois' ? 'Parfois' : 'Non');
          html += `<div class="response-card">
            <div class="card-row">
              <div class="card-meta">#${i+1} — ${date}</div>
              <div class="card-actions"><button class="btn" onclick="showDetail(${i})">Voir</button></div>
            </div>
            <div class="card-body">
              <p><strong>Ville:</strong> ${city}</p>
              <p><strong>Âge:</strong> ${age} — <strong>Profession:</strong> ${prof}</p>
              <p><strong>Difficulté:</strong> ${diff}</p>
            </div>
          </div>`;
        });
        html += '</div>';

        return html;
      }

      function renderFeaturesTab(){
        const featureCounts = {};
        allEntries.forEach(e=>{
          if(e.data.features && Array.isArray(e.data.features)){
            e.data.features.forEach(f=>{ featureCounts[f] = (featureCounts[f] || 0) + 1; });
          }
        });
        const sorted = Object.entries(featureCounts).sort((a,b)=>b[1]-a[1]);
        const labels = {
          'recherche-avancee': 'Recherche avancée',
          'messagerie': 'Messagerie',
          'verification': 'Vérification',
          'paiement-en-ligne': 'Paiement en ligne',
          'photos': 'Photos & visites virtuelles',
          'support-sms': 'Support SMS',
          'application-mobile': 'Application mobile',
          'offline': 'Mode hors-ligne'
        };
        let html = '<h3>Fonctionnalités les plus demandées</h3><div class="feature-list">';
        sorted.forEach(([feat, count])=>{
          const label = labels[feat] || feat;
          const pct = ((count / allEntries.length) * 100).toFixed(0);
          html += `<div class="feature-item"><strong>${label}</strong><span class="count">${count} (${pct}%)</span></div>`;
        });
        html += '</div>';
        return html;
      }

      function renderLocationsTab(){
        const locMap = {};
        allEntries.forEach(e=>{
          const city = e.data.city || 'Non spécifié';
          const neighborhood = e.data.neighborhood || 'Non spécifié';
          if(!locMap[city]) locMap[city] = {};
          if(!locMap[city][neighborhood]) locMap[city][neighborhood] = 0;
          locMap[city][neighborhood]++;
        });

        let html = '<h3>Répartition par ville et quartier</h3>';
        html += '<div class="location-grid">';
        Object.entries(locMap).forEach(([city, neighborhoods])=>{
          const total = Object.values(neighborhoods).reduce((a,b)=>a+b, 0);
          html += `<div class="location-card">
            <h4><i class="fas fa-city"></i> ${city}</h4>
            <p><strong>${total}</strong> réponses</p>`;
          Object.entries(neighborhoods).forEach(([hood, count])=>{
            html += `<p style="margin-left:8px"><i class="fas fa-map-pin"></i> ${hood}: <strong>${count}</strong></p>`;
          });
          html += '</div>';
        });
        html += '</div>';
        return html;
      }

      function renderInsightsTab(){
        const problems = {};
        allEntries.forEach(e=>{
          if(e.data.problems && Array.isArray(e.data.problems)){
            e.data.problems.forEach(p=>{ problems[p] = (problems[p] || 0) + 1; });
          }
        });
        const pLabels = {
          'prix': 'Prix trop élevés',
          'disponibilite': 'Manque d\'offres',
          'fiabilite': 'Fiabilité des annonces',
          'paiement': 'Options de paiement',
          'transport': 'Accessibilité/mobilité',
          'autre': 'Autre'
        };
        let html = '<h3>Difficultés rencontrées</h3><div class="feature-list">';
        Object.entries(problems).sort((a,b)=>b[1]-a[1]).forEach(([prob, count])=>{
          const label = pLabels[prob] || prob;
          const pct = ((count / allEntries.length) * 100).toFixed(0);
          html += `<div class="feature-item"><strong>${label}</strong><span class="count">${count} (${pct}%)</span></div>`;
        });
        html += '</div>';

        const demarcheurs = allEntries.filter(e=>e.data.demarcheur === 'oui').length;
        const demPct = allEntries.length > 0 ? ((demarcheurs / allEntries.length) * 100).toFixed(0) : 0;
        html += `<h3 style="margin-top:24px">Impact des démarcheurs</h3>
          <div class="feature-list">
            <div class="feature-item"><strong>Sollicités par démarcheurs</strong><span class="count">${demarcheurs} (${demPct}%)</span></div>
          </div>`;
        return html;
      }

      window.showDetail = function(idx){
        const e = allEntries[idx];
        const detail = JSON.stringify(e.data, null, 2);
        Swal.fire({
          title: `<i class="fas fa-file-lines" style="color:#2563eb"></i> Réponse #${idx+1}`,
          html: `<pre style="text-align:left;background:#f8fafc;padding:16px;border-radius:8px;overflow:auto;max-height:400px;font-size:12px;color:#1f2937">${detail}</pre>`,
          width: '90%',
          maxWidth: '600px',
          showConfirmButton: true,
          confirmButtonText: 'Fermer',
          confirmButtonColor: '#2563eb',
          allowOutsideClick: true,
          didOpen: () => { document.querySelector('.swal2-modal').style.borderRadius = '12px'; }
        });
      };

      if(window.firebaseAuth){
        window.firebaseAuth.onAuthStateChanged(user=>{ user ? renderAdmin() : renderLogin(); });
      } else {
        const raw = localStorage.getItem('ndaSurvey');
        allEntries = raw ? JSON.parse(raw).map((e,i)=>({id:i,data:Object.assign({_ts:e.ts}, e.data)})) : [];
        showAdminDashboard();
      }
    </script>
  </body>
</html>
